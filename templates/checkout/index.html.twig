{% extends 'base.html.twig' %}
{% block title %}Morent | Checkout
{% endblock %}
{% block body %}
	{% include 'navbar.html.twig' %}
	<div class="checkout">
		<div class="container-fluid">
				{{ form_start(form,{'attr':{'id': 'payment-form','method' : 'post'}}) }}
			<div class="row">
				<div class="col-lg-8">
					<div class="form-billing">
						<div class="title d-flex justify-content-between">
							<div class="title-content">
								<h3>Billing Info</h3>
								<p>Please enter your billing info</p>
							</div>
							<div class="step">
								<p>Step 1 of 4</p>
							</div>
						</div>
						
						<div class="row">
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.name) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.phoneNumber) }}

								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.address) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.townCity) }}
								</div>
							</div>
						</div>
					</div>
					<div class="rental-info">
						<div class="title d-flex justify-content-between">
							<div class="title-content">
									<h3>Rental Info</h3>
									<p>Please enter your rental date</p>
							</div>
							<div class="step">
								<p>Step 2 of 4</p>
							</div>
						</div>

						{# <div class="row">
							<h3 class="pick-up">Pick - Up</h3>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.pickUpLocation) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.pickUpDate) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.pickUpTime) }}
								</div>
							</div>
						</div>
						<div class="row">
							<h3 class="drop-off">Drop - Off</h3>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.dropOffLocation) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.dropOffDate) }}
								</div>
							</div>
							<div class="col-lg-6">
								<div class="mb-3">
									{{ form_row(form.dropOffTime) }}
								</div>
							</div>
						</div> #}

					</div>
					<div class="payment-method">
						<div class="title d-flex justify-content-between">
							<div class="title-content">
									<h3>Payment Method</h3>
									<p>Please enter your payment method</p>
							</div>
							<div class="step">
								<p>Step 3 of 4</p>
							</div>
						</div>

						<div class="payment-form">
							<div class="card-info">
								<div class="title d-flex justify-content-between">
									<h3>Credit Card</h3>
									<div class="logos">
										<img src="/images/visa.png" alt="">
										<img src="/images/mastercard.png" alt="">
									</div>
								</div>
								<div class="row">
									<div class="col-lg-6">
										<div class="mb-3">
											<div id="card-number-element" class="card-style"></div>
										</div>
									</div>
									<div class="col-lg-6">
										<div class="mb-3">
											<div id="card-expiry-element" class="card-style"></div>
										</div>
									</div>
									<div class="col-lg-6">
										<div class="mb-3">
											<div id="card-cvc-element" class="card-style"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="mb-3">
								<div class="method d-flex justify-content-between">
									<div class="p-method">
										<input type="radio" name="paymentradio" id="paypal"/>
										<label for="paypal">Paypal</label>
									</div>
									<div class="logo">
										<img src="/images/paypal.png" alt="">
									</div>
								</div>
							</div>
							<div class="mb-3">
								<div class="method d-flex justify-content-between">
									<div class="p-method">
										<input type="radio" name="paymentradio" id="bitcoin"/>
										<label for="bitcoin">Bitcoin</label>
									</div>
									<div class="logo">
										<img src="/images/bitcoin.png" alt="">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="confirmation">
						
						<div class="title d-flex justify-content-between">
							<div class="title-content">
								<h3>Confirmation</h3>
								<p>We are getting to the end. Just few clicks and your rental is ready!</p>
							</div>
							<div class="step">
								<p>Step 4 of 4</p>
							</div>
						</div>

						<div class="confirm mb-3 d-flex">
							{{form_widget(form.newsletter)}}
							{{form_label(form.newsletter)}}
						</div>
						<div class="confirm mb-3 d-flex">
							{{form_widget(form.termsConditions)}}
							<label for="checkout_termsConditions">I agree with our <a href="{{path("app_terms_conditions")}}">terms and conditions</a> and <a href="{{path("app_privacy_policy")}}">privacy policy</a>.</label>
						</div>
						{{ form_row(form.rentNow) }}
						<div class="safe-payment">
							<i class="fi fi-ts-shield-check"></i>
							<h3>All your data are safe</h3>
							<p>We are using the most advanced security to provide you the best experience ever.</p>
						</div>
					</div>
				</div>
				<div class="col-lg-4">
					<div class="rental-summary">
						<h3>Rental Summary</h3>
						<p>Prices may changes depending on the length of the rental and the price of your rental car.</p>
						<div class="rent-info d-flex">
							<div class="col-lg-6 col-md-6 col-6">
								<div class="car-img">
									<img src="{{car.img}}" alt="">
								</div>
							</div>
							<div class="col-lg-6 col-md-6 col-6">
								<div class="car-desc">
									<div class="car-name">
										{{car.name}}
									</div>
								</div>
							</div>
						</div>
						<div class="total">
							<div class="d-flex justify-content-between">
								<p>Sub Total</p>
								<p class="sub-price">{{total | format_currency('USD', {decimal_always_shown:true}, 'en')}}</p>
							</div>
							<div class="d-flex justify-content-between">
								<p>Tax</p>
								<p class="sub-price">$0</p>
							</div>
							<div class="promo-code mb-3">
									{{ form_row(form.promoCode) }}
								<a href="#">Apply Now</a>
								<input type="hidden" id="days" value="{{days}}">
								<input type="hidden" id="price" value="{{car.price}}">
							</div>
							<div class="total-rent-price">
								<div class="d-flex justify-content-between">
									<div class="text">
										<h3>Total Rental Price</h3>
										<p>Overall price and includes rental discount</p>
									</div>
									<div class="price">
										<span>{{total | format_currency('USD', {decimal_always_shown:true}, 'en')}}</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
				{{ form_end(form) }}
				<div id="card-errors" role="alert"></div>
		</div>
	</div>
	{% include 'footer.html.twig' %}

<script src="https://js.stripe.com/v3/"></script> #}
<script>
const stripe = Stripe('pk_test_51QZHxGFVL9wIFzsNvy9IdJtVBWFORGRGlzGBOatTli0TumAGHsZcmhqgfX3NPzkoV0IWwsuPuvSGItB492CE4Xzy00ePT9RZtF');
const elements = stripe.elements();

const style = {
  base: {
    fontSize: '14px',
    color: '#90A3B9',
    backgroundColor: '#fff',
    fontWeight: '400',
  },
};

const cardNumber = elements.create('cardNumber', { style });
const cardExpiry = elements.create('cardExpiry', { style });
const cardCvc = elements.create('cardCvc', { style });
let newTotal = 0;
cardNumber.mount('#card-number-element');
cardExpiry.mount('#card-expiry-element');
cardCvc.mount('#card-cvc-element');

document.querySelector('#payment-form').addEventListener('submit', async (event) => {
  event.preventDefault();
	if(newTotal === 0){
		newTotal = document.getElementById("days").value * document.getElementById("price").value;
	}		

  const form = event.target;
  const formData = new FormData(form);

	formData.append('newTotal', newTotal);
  try {
    const response = await fetch('{{ path("app_checkout", { id: car.id }) }}', {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Server returned ${response.status}: ${errorText}`);
    }

    const data = await response.json();

    if (data.error) {
      document.querySelector('#card-errors').textContent = data.error;
      return;
    }

    const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
      payment_method: {
        card: cardNumber,
      }
    });

    if (error) {
      document.querySelector('#card-errors').textContent = error.message;
    } else if (paymentIntent.status === 'succeeded') {
      console.log("Payment successful!");
			window.location.href = '{{ path("app_success_payment") }}';
    } else {
      console.error("Unexpected payment status:", paymentIntent.status);
      document.querySelector('#card-errors').textContent = "An error occurred during payment processing.";
    }

  } catch (error) {
    console.error("Error during payment process:", error);
    document.querySelector('#card-errors').textContent = "An error occurred during payment processing.";
  }
});

document.querySelector(".promo-code a").addEventListener("click", function(e){
	let input = document.querySelector(".promo-code input");
	input.style.border = "none";
	e.preventDefault();
	let promoCode = document.querySelector(".promo-code input").value;
	fetch("/promocode",{
		method:"POST",
		headers:{
			"Content-Type": "application/json",
		},
		body:JSON.stringify({
			promoCode,
			days: document.getElementById("days").value,
			price: document.getElementById("price").value,
		}),
	}).then(resp => {
		if(resp.status === 200){
			this.style.display = "none";
			input.setAttribute("disabled", "");
		}
		else{
			input.style.border = "1px solid #f00";
		}
		return resp.json();
	}).then(resp => {
		newTotal = resp.newTotal;
		document.querySelector(".total-rent-price .price span").innerText = "$" + resp.newTotal;
		document.querySelector(".total .sub-price").innerText = "$" + resp.newTotal;
	})
	.catch(err => {
		console.log(err);
	})
});


</script>
{% endblock %}
